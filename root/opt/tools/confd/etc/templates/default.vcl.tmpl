vcl 4.0;
import directors;

{{- range $i, $stackName := ls "/self/service/links" -}}

        {{- $backendPrefix := getenv "BACKEND_PREFIX" -}}

        {{- range $i2, $serviceName := ls (printf "/stacks/%s/services" $stackName) -}}
                {{- $serviceSplit := getenv "BACKEND_DIVIDER" -}}

                {{- $servicePrefix := index (split $serviceName $serviceSplit) 0 -}}

                {{- if eq $backendPrefix $servicePrefix -}}

                        {{- $path := (printf "/stacks/%s/services/%s/containers" $stackName $serviceName) -}}

                        {{- range $i3, $containerId := ls $path }}

backend {{ printf "backend_%d_%d_%d" $i $i2 $i3 }} {
        .host = "{{ getv (printf "%s/%s/primary_ip" $path $containerId) }}";
        .port = "80";
}
                        {{- end -}}
                {{ end -}}
        {{- end -}}

{{- end }}

sub vcl_init {

        new vdir = directors.round_robin();
{{- range $stackIdx, $stackName := ls "/self/service/links" -}}

        {{- $backendPrefix := getenv "BACKEND_PREFIX" -}}

        {{- range $serviceIdx, $serviceName := ls (printf "/stacks/%s/services" $stackName) -}}
                {{- $serviceSplit := getenv "BACKEND_DIVIDER" -}}

                {{- $servicePrefix := index (split $serviceName $serviceSplit) 0 -}}

                {{- if eq $backendPrefix $servicePrefix -}}

                        {{- $path := (printf "/stacks/%s/services/%s/containers" $stackName $serviceName) -}}

                        {{- range $containerIdx, $containerId := ls $path }}
        vdir.add_backend( {{ printf "backend_%d_%d_%d" $stackIdx $serviceIdx $containerIdx }} );
                        {{- end -}}
                {{ end -}}
        {{- end -}}

{{- end }}
}

# Customised 'vcl_hit'.
sub vcl_hit {
	return (deliver);
}

sub vcl_recv {
	
    # send all traffic to the bar director:
    set req.backend_hint = vdir.backend();
	 set resp.http.grace = 365d;
    unset req.http.Cache-Control;
}

sub vcl_backend_response {
    # Happens after we have read the response headers from the backend.
    #
    # Here you clean the response headers, removing silly Set-Cookie headers
    # and other mistakes your backend does.
	set beresp.ttl = 45s;
	set beresp.grace = 365d;
}

sub vcl_deliver {
    # Happens when we have all the pieces we need, and are about to send the
    # response to the client.
    #
    # You can do accounting or modifying the final object here.

    if (obj.hits > 0) {
		 set resp.http.X-Cache = "HIT";
	 } else {
		 set resp.http.X-Cache = "MISS";
	 }
}

sub vcl_hash {
    hash_data(req.http.method);
}
